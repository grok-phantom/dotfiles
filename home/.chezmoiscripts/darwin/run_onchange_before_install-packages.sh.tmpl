{{ if and (eq .chezmoi.os "darwin") (hasKey .packages "darwin") -}}
#!/bin/bash

set -eufo pipefail

export HOMEBREW_INSTALL_FROM_API=1
export HOMEBREW_API_DOMAIN="https://mirrors.aliyun.com/homebrew-bottles/api"
export HOMEBREW_BREW_GIT_REMOTE="https://mirrors.aliyun.com/homebrew/brew.git"
export HOMEBREW_CORE_GIT_REMOTE="https://mirrors.aliyun.com/homebrew/homebrew-core.git"
export HOMEBREW_BOTTLE_DOMAIN="https://mirrors.aliyun.com/homebrew/homebrew-bottles"

{{- $darwin := index .packages "darwin" -}}
{{- $brews := index $darwin "brews" -}}
{{- $casks := index $darwin "casks" -}}

/opt/homebrew/bin/brew bundle --no-lock --file=/dev/stdin <<EOF
{{- range $name := ($brews | sortAlpha | uniq) }}
brew "{{ $name }}"
{{- end }}
{{- range $name := ($casks | sortAlpha | uniq) }}
cask "{{ $name }}"
{{- end }}
EOF
{{ end -}}
