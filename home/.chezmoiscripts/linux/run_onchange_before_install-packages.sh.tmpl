{{ if and (eq .osid "linux-debian" "linux-raspbian" "linux-pop" "linux-ubuntu") (hasKey .packages "linux") -}}
{{- $linux := index .packages "linux" -}}
{{- $apt := index $linux "apt" -}}
{{- $classicSnaps := index $linux "snaps_classic" -}}
{{- $brews := list -}}
{{- if hasKey $linux "brews" -}}
{{-   $brews = index $linux "brews" -}}
{{- end -}}

{{- $sudo := "sudo " -}}
{{- if eq .chezmoi.username "root" -}}
{{-   $sudo = "" -}}
{{- end -}}

{{- $brew := "" -}}
{{- if lookPath "brew" -}}
{{-   $brew = "brew" -}}
{{- else if stat "/home/linuxbrew/.linuxbrew/bin/brew" -}}
{{-   $brew = "/home/linuxbrew/.linuxbrew/bin/brew" -}}
{{- end -}}

#!/bin/bash

set -eufo pipefail

{{- if gt (len $apt) 0 }}
{{ $sudo }}apt-get update
{{ $sudo }}apt-get install -y {{ $apt | sortAlpha | uniq | join " " }}
{{- end }}

{{- if and (lookPath "snap") (gt (len $classicSnaps) 0) }}
{{-   range ($classicSnaps | sortAlpha | uniq) }}
{{ $sudo }}snap install --classic {{ . }}
{{-   end }}
{{- end }}

{{- if and .homebrew (gt (len $brews) 0) (ne $brew "") }}
{{-   range ($brews | sortAlpha | uniq) }}
{{ $brew }} install {{ . }}
{{-   end }}
{{- end }}

if command -v zsh >/dev/null 2>&1 && command -v chsh >/dev/null 2>&1; then
  target_user="{{ .chezmoi.username }}"
  current_shell="$(getent passwd "${target_user}" | cut -d: -f7 || true)"
  if [ "${current_shell}" != "" ] && [ "${current_shell}" != "$(command -v zsh)" ]; then
    {{ $sudo }}chsh -s "$(command -v zsh)" "${target_user}"
  fi
fi

if command -v docker >/dev/null 2>&1; then
  target_user="{{ .chezmoi.username }}"
  if docker info >/dev/null 2>&1; then
    :
  else
    if id -nG "${target_user}" | grep -qw docker; then
      echo "docker installed but ${target_user} cannot access it without sudo; ensure the Docker service is running."
    else
      {{ $sudo }}groupadd -f docker
      {{ $sudo }}usermod -aG docker "${target_user}"
      echo "added ${target_user} to docker group for passwordless docker usage"
    fi
  fi
fi

{{ end -}}
